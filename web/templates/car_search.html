{% extends "base.html" %}
{% block title %}Пошук авто — Autoria Parser{% endblock %}
{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1rem;">Пошук авто</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
        Введіть ID, truck_car_id, марку, модель або власника (укр/анг). Марка і модель в базі англійською — підказки підказують за будь-яким текстом.
    </p>
    <div style="position: relative; max-width: 480px; margin-bottom: 1rem;">
        <input type="text" id="searchInput" placeholder="ID, truck_car_id, марка, модель, власник..." autocomplete="off"
               style="width: 100%; padding: 0.75rem 1rem; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem;">
        <div id="suggestList" class="suggest-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 2px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
    </div>
    <button type="button" class="btn" id="searchBtn">Шукати</button>
    <div id="searchMessage" class="message" style="display: none; margin-top: 1rem;"></div>
</div>

<div id="resultsContainer" style="display: none;">
    <div class="card">
        <h2 style="margin-bottom: 1rem;">Результати</h2>
        <div id="resultsList"></div>
    </div>
</div>
{% endblock %}
{% block extra_css %}
<style>
.suggest-list { list-style: none; }
.suggest-list li { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; }
.suggest-list li:hover { background: var(--border); }
.suggest-list li:last-child { border-bottom: none; }
.suggest-list .suggest-owner { font-weight: 600; color: var(--accent); }
.suggest-list .suggest-brand { color: var(--text); }
.suggest-list .suggest-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
.car-detail-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem; }
.car-detail-card .row-first { margin-bottom: 0.75rem; }
.car-detail-card .owner-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
.car-detail-card .owner-value { font-size: 1.1rem; font-weight: 600; color: var(--accent); }
.car-detail-card .link-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
.car-detail-card .link-value a { color: var(--accent); word-break: break-all; }
.car-detail-card .params { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem 1.5rem; margin-top: 1rem; font-size: 0.9rem; }
.car-detail-card .params dt { color: var(--text-muted); font-weight: normal; }
.car-detail-card .params dd { margin: 0; }
</style>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    var searchInput = document.getElementById('searchInput');
    var suggestList = document.getElementById('suggestList');
    var searchBtn = document.getElementById('searchBtn');
    var searchMessage = document.getElementById('searchMessage');
    var resultsContainer = document.getElementById('resultsContainer');
    var resultsList = document.getElementById('resultsList');

    var suggestTimer = null;
    var lastSuggestQ = '';

    function showMessage(text, isError) {
        searchMessage.style.display = 'block';
        searchMessage.className = 'message ' + (isError ? 'error' : 'success');
        searchMessage.textContent = text;
    }

    function hideSuggest() {
        suggestList.style.display = 'none';
        suggestList.innerHTML = '';
    }

    function renderSuggestItems(items) {
        if (!items.length) {
            suggestList.innerHTML = '<li style="color: var(--text-muted);">Нічого не знайдено</li>';
            suggestList.style.display = 'block';
            return;
        }
        suggestList.innerHTML = items.map(function(item) {
            var brandModel = [item.brand, item.model].filter(Boolean).join(' ');
            var meta = [item.year ? 'рік ' + item.year : '', item.truck_car_id ? 'truck_car_id: ' + item.truck_car_id : ''].filter(Boolean).join(' · ');
            return '<li data-id="' + item.id + '" data-q="' + (item.brand + ' ' + (item.model || '')).trim() + '">' +
                '<span class="suggest-owner">' + escapeHtml(item.owner) + '</span><br>' +
                '<span class="suggest-brand">' + escapeHtml(brandModel) + '</span>' +
                (meta ? '<div class="suggest-meta">' + escapeHtml(meta) + '</div>' : '') +
                '</li>';
        }).join('');
        suggestList.style.display = 'block';
        suggestList.querySelectorAll('li[data-id]').forEach(function(li) {
            li.addEventListener('click', function() {
                var id = parseInt(li.getAttribute('data-id'), 10);
                hideSuggest();
                loadCarDetail(id);
            });
        });
    }

    function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function fetchSuggest(q) {
        if (!q || q.length < 1) { hideSuggest(); return; }
        fetch('/api/car-search/suggest?q=' + encodeURIComponent(q) + '&limit=15')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (typeof data === 'object' && !Array.isArray(data) && data.error) {
                    suggestList.innerHTML = '<li style="color: var(--text-muted);">Помилка</li>';
                    suggestList.style.display = 'block';
                    return;
                }
                renderSuggestItems(Array.isArray(data) ? data : []);
            })
            .catch(function() {
                suggestList.innerHTML = '<li style="color: var(--text-muted);">Помилка завантаження</li>';
                suggestList.style.display = 'block';
            });
    }

    searchInput.addEventListener('input', function() {
        var q = searchInput.value.trim();
        lastSuggestQ = q;
        clearTimeout(suggestTimer);
        if (!q) { hideSuggest(); return; }
        suggestTimer = setTimeout(function() { fetchSuggest(q); }, 280);
    });

    searchInput.addEventListener('blur', function() {
        setTimeout(hideSuggest, 180);
    });

    document.addEventListener('mousedown', function(e) {
        var t = e.target;
        if (t !== searchInput && t !== searchBtn && !suggestList.contains(t)) hideSuggest();
    });

    searchBtn.addEventListener('mousedown', function() {
        hideSuggest();
    });

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            hideSuggest();
            runSearch();
        }
    });

    function runSearch() {
        var q = searchInput.value.trim();
        var truckId = /^\d+$/.test(q) ? parseInt(q, 10) : null;
        if (!q) {
            showMessage('Введіть запит для пошуку', true);
            resultsContainer.style.display = 'none';
            return;
        }
        var url = truckId != null && q.length < 6
            ? '/api/car-search?truck_car_id=' + truckId
            : '/api/car-search?q=' + encodeURIComponent(q);
        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (typeof data === 'object' && !Array.isArray(data) && data.error) {
                    showMessage(data.error, true);
                    resultsContainer.style.display = 'none';
                    return;
                }
                var list = Array.isArray(data) ? data : [];
                showMessage(list.length ? 'Знайдено: ' + list.length : 'Нічого не знайдено', false);
                resultsContainer.style.display = 'block';
                renderResults(list);
            })
            .catch(function(e) {
                showMessage('Помилка: ' + e.message, true);
                resultsContainer.style.display = 'none';
            });
    }

    searchBtn.addEventListener('click', runSearch);

    function loadCarDetail(carId) {
        fetch('/api/car/' + carId + '/detail')
            .then(function(r) { return r.json(); })
            .then(function(car) {
                if (car.error) {
                    showMessage(car.error, true);
                    resultsContainer.style.display = 'none';
                    return;
                }
                showMessage('Знайдено 1 авто', false);
                resultsContainer.style.display = 'block';
                resultsList.innerHTML = renderOneCard(car);
            })
            .catch(function(e) {
                showMessage('Помилка: ' + e.message, true);
                resultsContainer.style.display = 'none';
            });
    }

    function renderOneCard(car) {
        return '<div class="car-detail-card">' + buildCardContent(car) + '</div>';
    }

    function buildCardContent(car) {
        var html = '<div class="row-first">' +
            '<div class="owner-label">Власник</div>' +
            '<div class="owner-value">' + escapeHtml(car.owner) + '</div>' +
            '</div>';
        html += '<div class="link-label">Посилання на AutoRia</div>';
        html += '<div class="link-value"><a href="' + escapeHtml(car.auto_ria_url || car.link_path || '#') + '" target="_blank" rel="noopener">' + escapeHtml(car.auto_ria_url || car.link_path || '—') + '</a></div>';
        var params = [
            ['Марка', car.brand],
            ['Модель', car.model],
            ['Рік', car.year],
            ['Ціна ($)', car.price],
            ['Пробіг (км)', car.mileage],
            ['Пальне', car.fuel_type],
            ['КПП', car.transmission],
            ['Колір', car.color],
            ['Локація', car.location],
            ['Статус', car.processed_status],
            ['truck_car_id', car.truck_car_id],
        ];
        html += '<dl class="params">';
        params.forEach(function(p) {
            if (p[1] !== undefined && p[1] !== null && p[1] !== '') {
                html += '<dt>' + escapeHtml(p[0]) + '</dt><dd>' + escapeHtml(String(p[1])) + '</dd>';
            }
        });
        html += '</dl>';
        if (car.description) {
            html += '<div class="link-label" style="margin-top: 0.75rem;">Опис</div><div style="font-size: 0.9rem; white-space: pre-wrap;">' + escapeHtml(car.description) + '</div>';
        }
        return html;
    }

    function renderResults(list) {
        resultsList.innerHTML = list.map(function(car) {
            return '<div class="car-detail-card">' + buildCardContent(car) + '</div>';
        }).join('');
    }
})();
</script>
{% endblock %}
